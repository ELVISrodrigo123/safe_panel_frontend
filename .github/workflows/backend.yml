name: Backend CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    name: ðŸ§ª Tests y Calidad
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
        ports: [5432:5432]

    steps:
    - name:  Checkout code
      uses: actions/checkout@v4

    - name:  Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name:  Install dependencies
      run: |
        cd guardian_core
        pip install -r requirements.txt

    - name:  Setup Database
      run: |
        cd guardian_core
        python manage.py migrate
      env:
        SECRET_KEY: 'test-key-123'
        DEBUG: 'True'
        DATABASE_URL: 'postgresql://test_user:test_pass@localhost:5432/test_db'

    - name:  Run Quality Checks
      run: |
        make lint
        make deadcode

    - name:  Run Tests
      run: |
        make test
      env:
        SECRET_KEY: 'test-key-123'
        DEBUG: 'True'
        DATABASE_URL: 'postgresql://test_user:test_pass@localhost:5432/test_db'